{% extends 'base.html' %}

{% block content %}
<div class="row page-header">
    <div class="col section-card">
        <h2>Dispatch Metrics</h2>
        <p>Metrics for San Francisco Police Department data between January 13, 2018 and January 24, 2018.</p>
    </div>
</div>

<!-- Metric charts HTML -->
<div class="row">
    <!-- Average Response Time Per Call Type Group chart section -->
    <div class="col-sm section-card">
        <h3>Average Response Time Per Call Type Group</h3>
        <p>
            Average duration from the time the call was received to time the 
            emergency unit was enroute.
        </p>
        <hr />

        <canvas id="typeResponseTime" height="300" width="auto"></canvas>
    </div>
    <!-- End Average Response Time Per Call Type Group chart section -->

    <!-- Average Calls Per Hour chart section -->
    <div class="col-sm section-card">
        <h3>Average Calls Per Hour</h3>
        <p>Average number of calls per hour of the day.</p>
        <hr />

        <canvas id="avgCallsPerHour" height="300" width="auto"></canvas>
    </div>
    <!-- End Average Calls Per Hour chart section -->
</div>
<div class="row">
    <!-- Number of Calls by Battalion chart section -->
    <div class="col-sm section-card">
        <ul class="nav nav-pills nav-fill" id="battalionTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="battalion-calls-tab" 
                data-toggle="tab" href="#battalion-calls" role="tab" aria-controls="battalion-calls" aria-selected="true">
                    Number of Calls by Battalion
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="battalion-dist-tab" data-toggle="tab"
                href="#battalion-dist" role="tab" aria-controls="battalion-dist" aria-selected="false">
                    Battalion Call Type Distribution
                </a>
            </li>
        </ul>
        
        <div class="tab-content" id="battalionTabContent">
            <div class="tab-pane fade show active" id="battalion-calls" 
            role="tabpanel" aria-labelledby="battalion-calls-tab">
                <h3 class="mt-3">Number of Calls by Battalion</h3>
                <p>
                    Using this data can help the SFPD make educated decisions on which
                    battalions may need more allocated resources.
                </p>
                <hr />
        
                <canvas id="battalionDistrib" height="300" width="auto"></canvas>
            </div>
            <div class="tab-pane fade" id="battalion-dist" role="tabpanel" 
            aria-labelledby="battalion-dist-tab">
                <h3 class="mt-3">Battalion Call Type Distribution</h3>
                
                <form id="battalionDistForm" method="post">
                    <div class="form-group">
                        <label for="battalion">
                            Select a battalion below to chart its call type
                            distribution.
                        </label>
                        <select name="battalion" class="custom-select" id="battalion" aria-describedby="battalionHelp">
                        </select>
                        <small id="battalionHelp" class="form-text text-muted">Select a battalion to chart.</small>
                    </div>
                    {% csrf_token %}
                </form>
        
                <!-- Battalion distribution results -->
                <div id="trendResults" style="display:none;">
                    <hr />
                    <canvas id="battalionDistChart" height="300" width="auto"></canvas>
                </div>
                <!-- End battalion distribution results -->
            </div>
        </div>
    </div>
    <!-- End Number of Calls by Battalion chart section -->

    <!-- Most-likely dispatch type section -->
    <div class="col-sm section-card">
        <h3>Calculate Most-Likely Dispatch Type</h3>
        <p>Calculates the most-likely dispatch to be required provided an address and time.</p>
        <hr />
        
        <form id="dispatchTypeForm" method="post">
            <div class="form-group">
                <label for="address">Street Address</label>
                <input name="address" type="text" class="form-control" id="address" aria-describedby="addressHelp" placeholder="Enter a street address." required>
                <small id="addressHelp" class="form-text text-muted">Enter the dispatch location (e.g. 200 Market St, San Francisco, CA)</small>
            </div>
            <div class="form-group">
                <label for="timestamp">Time</label>
                <input name="time" class="form-control" id="time" aria-describedby="timestampHelp" type="time" step="1" required></input>
                <small id="timestampHelp" class="form-text text-muted">Enter the timestamp for the dispatch (e.g. hh:mm:ss (AM/PM), hh:mm (AM/PM), hh)</small>
            </div>
            <div class="form-group">
                <label for="radius">Search Radius</label>
                <select name="radius" class="custom-select" id="radius" aria-describedby="radiusHelp">
                    <option value="0.25">1/4 mile</option>
                    <option value="0.5" selected>1/2 mile</option>
                    <option value="0.75">3/4 mile</option>
                    <option value="1">1 mile</option>
                    <option value="1.5">1.5 miles</option>
                    <option value="2">2 miles</option>
                </select>
                <small id="radiusHelp" class="form-text text-muted">Select a radius to search nearby.</small>
            </div>
            <button type="submit" class="btn btn-dark">Calculate Dispatch Type</button>
            {% csrf_token %}
        </form>

        <!-- Most-likely dispatch type results -->
        <div id="nearbyResults" style="display:none;"></div>
        <!-- End most-likely dispatch type results -->
    </div>
    <!-- End most-likely dispatch type section -->
</div>
<!-- End metric charts HTML -->
{% endblock %}

{% load static %}
{% block scripts %}
{{ block.super }}
<script>
$("#dispatchTypeForm").submit(function(e) {
    var endpoint = '/api/calls/nearby';
    $.ajax({
        method: "POST",
        url: endpoint,
        data: $("#dispatchTypeForm").serialize(),
        success: function(data) {
            // Get nearby calls
            getNearbyCalls(data);
        },
        error: function(resp) {
            console.error('An error occurred when retrieving nearby call data.');
            var error = '<div class="alert alert-danger mt-3" role="alert"><p class="mb-0">' + 
                resp.responseJSON.message + ' Please try again.</p></div>';
            
            var results = $("#nearbyResults");
            results.html(error);
            results.fadeIn();
        }
    });

    // Prevent form submit causing page change
    e.preventDefault();
});

// Remove results on form change, since a change in the form elements
// makes the results no longer valid.
$('#dispatchTypeForm').change(function() {
    $('#nearbyResults').fadeOut();
});

function getNearbyCalls(data) {
    data = data.data;
    var results = $("#nearbyResults");
    var nearbyData = '<div class="alert alert-info mt-3" role="alert"><p class="mb-0">Most likely dispatch required: <b>' + 
        data.unit_type_match + '</b> with <i>' + data.unit_type_match_count + 
        '</i> matching incidents.</p></div>';
    results.html(nearbyData);
    results.fadeIn();
}

/**
 * Populates the list of battalions in the battalionDistForm for
 * user selection.
 */
 function populateBattalionList() {
    var endpoint = '/api/calls/battalions';
    
    $.ajax({
        method: "GET",
        url: endpoint,
        success: function(data) {
            // Remove top status layer of data
            data = data.data;

            var battalion; // Holds the name of the neighborhood
            var optionHtml; // The option HTML element
            for (var i = 0; i < data.length; i++) {
                battalion = data[i];
                optionHtml = '<option value="' + battalion + '">' + battalion + '</option>';
                
                // Add to the select element
                $('#battalion').append(optionHtml);
            }
            
            // Submit the form to show example data
            $("#battalionDistForm").submit();
        },
        error: function(resp) {
            console.error('An error occurred when retrieving the battalion list.');
        }
    });
}

// Populates the battalions list in the battalionDistForm
populateBattalionList();
</script>
{% endblock %}