{% extends 'base.html' %}

{% block content %}
<div class="row page-header">
    <div class="col section-card">
        <h2>Dispatch Metrics</h2>
        <p>Metrics for San Francisco Police Department data between January 13, 2018 and January 24, 2018.</p>
    </div>
</div>

<!-- Metric charts HTML -->
<div class="row">
    <!-- Average Response Time Per Call Type Group chart section -->
    <div class="col-sm section-card">
        <h3>Average Response Time Per Call Type Group</h3>
        <p>
            Average duration from the time the call was received to time the 
            emergency unit was enroute.
        </p>
        <hr />

        <canvas id="typeResponseTime" height="300" width="auto"></canvas>
    </div>
    <!-- End Average Response Time Per Call Type Group chart section -->

    <!-- Average Calls Per Hour chart section -->
    <div class="col-sm section-card">
        <h3>Average Calls Per Hour</h3>
        <p>Average number of calls per hour of the day.</p>
        <hr />

        <canvas id="avgCallsPerHour" height="300" width="auto"></canvas>
    </div>
    <!-- End Average Calls Per Hour chart section -->
</div>
<div class="row">
    <!-- Number of Calls by Battalion chart section -->
    <div class="col-sm section-card">
        <h3>Number of Calls by Battalion</h3>
        <p>
            Using this data can help the SFPD make educated decisions on which
            battalions may need more allocated resources.
        </p>
        <hr />

        <canvas id="battalionDistrib" height="300" width="auto"></canvas>
    </div>
    <!-- End Number of Calls by Battalion chart section -->

    <!-- Most-likely dispatch type section -->
    <div class="col-sm section-card">
        <h3>Calculate Most-Likely Dispatch Type</h3>
        <p>Calculates the most-likely dispatch to be required provided an address and time.</p>
        <hr />
        
        <form id="dispatchTypeForm" method="post">
            <div class="form-group">
                <label for="address">Street Address</label>
                <input name="address" type="text" class="form-control" id="address" aria-describedby="addressHelp" placeholder="Enter a street address" required>
                <small id="addressHelp" class="form-text text-muted">Enter the dispatch location.</small>
            </div>
            <div class="form-group">
                <label for="timestamp">Time</label>
                <input name="time" class="form-control" id="time" aria-describedby="timestampHelp" type="time" step="1" required></input>
                <small id="timestampHelp" class="form-text text-muted">Enter the timestamp for the dispatch.</small>
            </div>
            <div class="form-group">
                <label for="radius">Search Radius</label>
                <select name="radius" class="custom-select" id="radius" aria-describedby="radiusHelp">
                    <option value="0.25">1/4 mile</option>
                    <option value="0.5" selected>1/2 mile</option>
                    <option value="0.75">3/4 mile</option>
                    <option value="1">1 mile</option>
                    <option value="1.5">1.5 miles</option>
                    <option value="2">2 miles</option>
                </select>
                <small id="radiusHelp" class="form-text text-muted">Select a radius to search nearby.</small>
            </div>
            <button type="submit" class="btn btn-dark">Calculate Dispatch Type</button>
            {% csrf_token %}
        </form>

        <!-- Most-likely dispatch type results -->
        <div id="nearbyResults" style="display:none;"></div>
        <!-- End most-likely dispatch type results -->
    </div>
    <!-- End most-likely dispatch type section -->
</div>
<!-- End metric charts HTML -->
{% endblock %}

{% load static %}
{% block scripts %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/Chart.bundle.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/chart_utils.js' %}"></script>
<script type="text/javascript" src="{% static 'js/metrics_charts.js' %}"></script>
<script>
$("#dispatchTypeForm").submit(function(e) {
    var endpoint = '/api/calls/nearby';
    $.ajax({
        method: "POST",
        url: endpoint,
        data: $("#dispatchTypeForm").serialize(),
        success: function(data) {
            // Get nearby calls
            getNearbyCalls(data);
        },
        error: function(resp) {
            console.error('An error occurred when retrieving nearby call data.');
            var error = '<div class="alert alert-danger mt-3" role="alert"><p class="mb-0">' + 
                resp.responseJSON.message + ' Please try again.</p></div>';
            
            var results = $("#nearbyResults");
            results.html(error);
            results.fadeIn();
        }
    });

    // Prevent form submit causing page change
    e.preventDefault();
});

// Remove results on form change, since a change in the form elements
// makes the results no longer valid.
$('#dispatchTypeForm').change(function() {
    $('#nearbyResults').fadeOut();
});

function getNearbyCalls(data) {
    data = data.data;
    var results = $("#nearbyResults");
    var nearbyData = '<div class="alert alert-info mt-3" role="alert"><p class="mb-0">Most likely dispatch required: <b>' + 
        data.unit_type_match + '</b> with <i>' + data.unit_type_match_count + 
        '</i> matching incidents.</p></div>';
    results.html(nearbyData);
    results.fadeIn();
}
</script>
{% endblock %}